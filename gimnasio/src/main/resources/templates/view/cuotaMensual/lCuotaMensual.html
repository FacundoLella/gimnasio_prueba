<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>CUOTAS MENSUALES</title>
    <link th:href="@{/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/bootstrap/css/jumbotron.css}" rel="stylesheet">
    <link th:href="@{/bootstrap/css/sticky-footer-navbar.css}" rel="stylesheet">
    <link href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
    body {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
  </style>
  </head>

  <body th:attr="data-callback-base-url=${@environment.getProperty('mercadopago.callback-base-url','')}">

    <header th:insert="~{fragments/menubody :: menu-principal}"></header>

    <main role="main">
      <hr>
      <div class="container">

        <div class="card">
          <h4 class="card-header"><strong>Lista Cuotas Mensuales</strong></h4>
          <div class="card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center">
                <span class="font-weight-bold mr-3" id="totalCuotas">Total seleccionado: $0.00</span>
                <span class="text-muted" id="socioSeleccionado"></span>
              </div>
              <div>
                <button type="button" class="btn btn-success" id="btnPagarCuotas" disabled>
                  <i class="bi bi-cash-coin" aria-hidden="true"></i>
                  <span class="ml-1">Pagar seleccionadas</span>
                </button>
              </div>
            </div>
            <div class="flex-wrap align-items-center justify-content-between mb-3">
                <form th:action="@{/cuotaMensual/buscarCuotasDeSocio}" method="get" class="d-flex flex-grow-1" th:if="${session.rol == 'ADMINISTRADOR' or session.rol == 'EMPLEADO'}">
                    <input type="text" name="dni" class="form-control me-2" placeholder="Ingresar DNI del Socio">
                    <button type="submit" class="btn btn-outline-success">Buscar</button>
                </form>
                <a class="btn btn-outline-success" th:if="${session.rol == 'ADMINISTRADOR' or session.rol == 'EMPLEADO'}" th:href="@{/cuotaMensual/volver}" role="button">Volver</a>
            </div>  

            <hr>
            <div th:if="${msgExito != null}" class='alert alert-success' th:text="${msgExito}" role='alert'></div>
            <div th:if="${msgError != null}" class='alert alert-danger' th:text="${msgError}" role='alert'></div>

            <table class="table table-hover w-100">
              <thead class="thead-light">
                <tr>
                  <th scope="col">Seleccionar</th>
                  <th scope="col">Acciones</th>
                  <th scope="col">Socio</th>
                  <th scope="col">Mes</th>
                  <th scope="col">Año</th>
                  <th scope="col">Estado</th>
                  <th scope="col">Vencimiento</th>
                  <th scope="col">Valor</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="cuota : ${listaCuotaMensual}">
                    <td class="align-middle">
                      <input type="checkbox" class="cuota-checkbox" th:value="${cuota.id}"
                        th:data-monto="${cuota.valorCuota.valorCuota}"
                        th:data-socio-id="${cuota.socio.id}"
                        th:data-socio="|${cuota.socio.nombre} ${cuota.socio.apellido}|"
                        th:data-periodo="|${#strings.capitalize(cuota.mes.name().toLowerCase())} ${cuota.anio}|"
                        th:disabled="${cuota.estado != T(com.fioritech.gimnasio.business.domain.enums.EstadoCuotaMensual).ADEUDADA}"
                        aria-label="Seleccionar cuota mensual" />
                    </td>
                    <td>
                       <a  th:href="@{/cuotaMensual/consultar/{id} (id=${cuota.id}) }" class="btn btn-success btn-sm" role="button" title="Consultar"><i class="fas fa-eye" aria-hidden="true"></i></a>
                      <a th:if="${session.rol == 'ADMINISTRADOR' or session.rol == 'EMPLEADO'}" th:href="@{/cuotaMensual/modificar/{id} (id=${cuota.id}) }" class="btn btn-success btn-sm" role="button" title="Modificar"><i class="fas fa-pencil-alt" aria-hidden="true"></i></a>
                      <a th:if="${session.rol == 'ADMINISTRADOR' or session.rol == 'EMPLEADO'}" th:href="@{/cuotaMensual/baja/{id} (id=${cuota.id}) }" class="btn btn-success btn-sm confirmar" role="button" title="Baja"><i class="fas fa-trash" aria-hidden="true"></i></a>
                    </td>
                 
                  <td th:text="|${cuota.socio.nombre} ${cuota.socio.apellido}|"></td>
                  <td th:text="${#strings.capitalize(cuota.mes.name().toLowerCase())}"></td>
                  <td th:text="${cuota.anio}"></td>
                  <td th:text="${#strings.capitalize(cuota.estado.name().toLowerCase())}"></td>
                  <td th:text="${#temporals.format(cuota.fechaVencimiento, 'dd/MM/yyyy')}"></td>
                  <td th:text="${#numbers.formatDecimal(cuota.valorCuota.valorCuota, 1, 'COMMA', 2, 'POINT')}"></td>
                </tr>
              </tbody>
            </table>

          </div>
        </div>
      </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script th:src="@{/bootstrap/js/bootstrap.min.js}"></script>

    <script>
      const dialogoConfirm = function (e) {
        if (!confirm('¿Está seguro de eliminar la información?')) {
          e.preventDefault();
        }
      };
      document.querySelectorAll('.confirmar').forEach(function(elemento) {
        elemento.addEventListener('click', dialogoConfirm, false);
      });

      (function () {
        const checkboxes = Array.from(document.querySelectorAll('.cuota-checkbox'));
        const totalLabel = document.getElementById('totalCuotas');
        const socioLabel = document.getElementById('socioSeleccionado');
        const pagarButton = document.getElementById('btnPagarCuotas');

        if (!checkboxes.length || !totalLabel || !pagarButton) {
          return;
        }

        const formatoMoneda = function (valor) {
          return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(valor);
        };

        const htmlOriginalBoton = pagarButton.innerHTML;

        const obtenerSeleccionadas = function () {
          return checkboxes.filter(function (cb) { return cb.checked && !cb.disabled; });
        };

        const actualizarResumen = function () {
          const seleccionadas = obtenerSeleccionadas();
          const total = seleccionadas.reduce(function (acumulado, cb) {
            const monto = parseFloat(cb.dataset.monto || '0');
            return acumulado + (isNaN(monto) ? 0 : monto);
          }, 0);

          totalLabel.textContent = 'Total seleccionado: ' + formatoMoneda(total);

          if (seleccionadas.length > 0) {
            socioLabel.textContent = 'Socio: ' + (seleccionadas[0].dataset.socio || '');
          } else {
            socioLabel.textContent = '';
          }

          pagarButton.disabled = seleccionadas.length === 0;
          return { seleccionadas: seleccionadas, total: total };
        };

        checkboxes.forEach(function (cb) {
          cb.addEventListener('change', function (event) {
            if (!event.target.checked) {
              actualizarResumen();
              return;
            }

            const seleccionadas = obtenerSeleccionadas();
            const socioIds = new Set(seleccionadas.map(function (item) { return item.dataset.socioId; }));
            if (socioIds.size > 1) {
              alert('Sólo puede pagar cuotas pertenecientes al mismo socio.');
              event.target.checked = false;
            }
            actualizarResumen();
          });
        });

        pagarButton.addEventListener('click', async function () {
          const { seleccionadas, total } = actualizarResumen();
          if (seleccionadas.length === 0) {
            return;
          }

          const periodos = seleccionadas.map(function (cb) { return cb.dataset.periodo; }).join(', ');
          const socioNombre = seleccionadas[0].dataset.socio || '';
          const ids = seleccionadas.map(function (cb) { return cb.value; });
          const referencia = ['CUOTAS', Date.now(), ids.join(',')].join('~');
          const totalRedondeado = Number(total.toFixed(2));
          const overrideBaseUrl = document.body.dataset.callbackBaseUrl;
          const baseUrl = overrideBaseUrl && overrideBaseUrl.length > 0 ? overrideBaseUrl : window.location.origin;
          const useHttps = baseUrl.startsWith('https://');
          const skipWarningParam = baseUrl.includes('ngrok') ? '?ngrok-skip-browser-warning=true' : '';
          const successUrl = baseUrl + '/mercadopago/success' + skipWarningParam;
          const failureUrl = baseUrl + '/mercadopago/failure' + skipWarningParam;
          const pendingUrl = baseUrl + '/mercadopago/pending' + skipWarningParam;
          const notificationUrl = baseUrl + '/mercadopago/webhook';

          pagarButton.disabled = true;
          pagarButton.innerHTML = 'Conectando con Mercado Pago...';

          try {
            const response = await fetch('/api/mercadopago/preferences', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                title: 'Cuotas de ' + socioNombre.trim(),
                description: 'Períodos: ' + periodos,
                quantity: 1,
                unitPrice: totalRedondeado,
                currencyId: 'ARS',
                externalReference: referencia,
                successUrl,
                failureUrl,
                pendingUrl,
                autoReturn: useHttps ? 'approved' : undefined,
                notificationUrl
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(errorText || 'No fue posible crear la preferencia en Mercado Pago');
            }

            const preference = await response.json();
            const destino = preference.initPoint || preference.sandboxInitPoint;
            if (!destino) {
              throw new Error('Mercado Pago no devolvió un enlace de pago.');
            }
            window.location.href = destino;
          } catch (error) {
            alert(error.message || 'No se pudo iniciar el pago en Mercado Pago.');
            pagarButton.disabled = false;
            pagarButton.innerHTML = htmlOriginalBoton;
          }
        });

        actualizarResumen();
      })();
    </script>

  </body>
</html>
